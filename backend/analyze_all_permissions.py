#!/usr/bin/env python
"""
Script pour analyser toutes les permissions existantes et recommander un syst√®me complet
"""

import os
import sys
import django

# Configuration Django
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'barstock_api.settings')
django.setup()

from accounts.models import Permission

def analyze_current_permissions():
    """Analyser toutes les permissions actuelles"""
    print("üìä PERMISSIONS ACTUELLES DANS LE SYST√àME")
    print("=" * 60)
    
    all_permissions = Permission.objects.all().order_by('category', 'code')
    
    # Grouper par cat√©gorie
    categories = {}
    for perm in all_permissions:
        cat = perm.category or 'Autre'
        if cat not in categories:
            categories[cat] = []
        categories[cat].append(perm)
    
    print(f"üìà Total permissions: {all_permissions.count()}")
    print(f"üìÅ Cat√©gories: {len(categories)}")
    
    print(f"\nüìã D√âTAIL PAR CAT√âGORIE:")
    for cat, perms in sorted(categories.items()):
        active_count = len([p for p in perms if p.is_active])
        print(f"\nüîπ {cat.upper()} ({len(perms)} permissions, {active_count} actives)")
        
        for perm in perms:
            status = "‚úÖ" if perm.is_active else "‚ùå"
            print(f"   {status} {perm.code} - {perm.name}")
    
    return categories

def recommend_complete_permission_system():
    """Recommander un syst√®me de permissions complet pour une application web s√©curis√©e"""
    print(f"\nüîê SYST√àME DE PERMISSIONS RECOMMAND√â")
    print("=" * 60)
    print("Bas√© sur les meilleures pratiques de s√©curit√© pour applications web")
    
    recommended_permissions = {
        "users": [
            ("users.view", "Voir les utilisateurs", "Consulter la liste des utilisateurs"),
            ("users.create", "Cr√©er des utilisateurs", "Ajouter de nouveaux utilisateurs"),
            ("users.update", "Modifier les utilisateurs", "Modifier les informations utilisateur"),
            ("users.delete", "Supprimer les utilisateurs", "Supprimer des comptes utilisateur"),
            ("users.activate", "Activer/D√©sactiver", "G√©rer le statut actif des utilisateurs"),
            ("users.reset_password", "R√©initialiser mot de passe", "R√©initialiser les mots de passe"),
            ("users.assign_permissions", "Attribuer permissions", "G√©rer les permissions utilisateur"),
            ("users.view_activities", "Voir activit√©s", "Consulter l'historique des activit√©s"),
        ],
        
        "sales": [
            ("sales.view", "Voir les ventes", "Consulter les ventes"),
            ("sales.create", "Cr√©er des ventes", "Effectuer des ventes"),
            ("sales.update", "Modifier les ventes", "Modifier des ventes existantes"),
            ("sales.delete", "Supprimer les ventes", "Annuler/supprimer des ventes"),
            ("sales.approve", "Approuver les ventes", "Valider des ventes importantes"),
            ("sales.refund", "Rembourser", "Effectuer des remboursements"),
            ("sales.discount", "Appliquer remises", "G√©rer les remises et promotions"),
        ],
        
        "finances": [
            ("finances.view", "Voir les finances", "Consulter les donn√©es financi√®res"),
            ("finances.reports", "Rapports financiers", "G√©n√©rer des rapports financiers"),
            ("finances.export", "Exporter donn√©es", "Exporter les donn√©es financi√®res"),
            ("finances.history", "Historique des ventes", "Consulter l'historique des transactions"),
            ("finances.analytics", "Analyses financi√®res", "Acc√©der aux analyses avanc√©es"),
            ("finances.budgets", "G√©rer budgets", "Configurer et suivre les budgets"),
            ("finances.taxes", "Gestion fiscale", "G√©rer les taxes et d√©clarations"),
        ],
        
        "inventory": [
            ("inventory.view", "Voir l'inventaire", "Consulter les stocks"),
            ("inventory.create", "Ajouter produits", "Ajouter de nouveaux produits"),
            ("inventory.update", "Modifier produits", "Modifier les informations produits"),
            ("inventory.delete", "Supprimer produits", "Retirer des produits"),
            ("inventory.adjust", "Ajuster stocks", "Corriger les quantit√©s en stock"),
            ("inventory.transfer", "Transf√©rer stocks", "D√©placer des stocks entre emplacements"),
            ("inventory.alerts", "Alertes stock", "G√©rer les alertes de stock bas"),
            ("inventory.audit", "Audit inventaire", "Effectuer des audits d'inventaire"),
        ],
        
        "products": [
            ("products.view", "Voir les produits", "Consulter le catalogue produits"),
            ("products.create", "Cr√©er produits", "Ajouter de nouveaux produits"),
            ("products.update", "Modifier produits", "Modifier les produits existants"),
            ("products.delete", "Supprimer produits", "Retirer des produits du catalogue"),
            ("products.categories", "G√©rer cat√©gories", "Organiser les cat√©gories de produits"),
            ("products.pricing", "G√©rer prix", "Modifier les prix et tarifications"),
            ("products.import", "Importer produits", "Importer des produits en masse"),
            ("products.export", "Exporter produits", "Exporter le catalogue"),
        ],
        
        "orders": [
            ("orders.view", "Voir les commandes", "Consulter les commandes"),
            ("orders.create", "Cr√©er commandes", "Passer de nouvelles commandes"),
            ("orders.update", "Modifier commandes", "Modifier des commandes existantes"),
            ("orders.delete", "Supprimer commandes", "Annuler des commandes"),
            ("orders.approve", "Approuver commandes", "Valider des commandes importantes"),
            ("orders.fulfill", "Traiter commandes", "Marquer comme trait√©es"),
            ("orders.track", "Suivre commandes", "Suivre le statut des commandes"),
        ],
        
        "kitchen": [
            ("kitchen.view", "Voir cuisine", "Acc√©der √† l'interface cuisine"),
            ("kitchen.orders", "G√©rer commandes", "Traiter les commandes cuisine"),
            ("kitchen.recipes", "G√©rer recettes", "Modifier les recettes et compositions"),
            ("kitchen.prep", "Gestion pr√©paration", "Organiser la pr√©paration"),
            ("kitchen.inventory", "Stock cuisine", "G√©rer les stocks cuisine"),
            ("kitchen.equipment", "√âquipements", "G√©rer les √©quipements cuisine"),
        ],
        
        "tables": [
            ("tables.view", "Voir les tables", "Consulter l'√©tat des tables"),
            ("tables.manage", "G√©rer tables", "Ouvrir/fermer des tables"),
            ("tables.assign", "Attribuer tables", "Assigner des serveurs aux tables"),
            ("tables.reservations", "R√©servations", "G√©rer les r√©servations"),
            ("tables.layout", "Configuration", "Modifier la disposition des tables"),
        ],
        
        "supplies": [
            ("supplies.view", "Voir fournitures", "Consulter les fournitures"),
            ("supplies.create", "Ajouter fournitures", "Ajouter de nouvelles fournitures"),
            ("supplies.update", "Modifier fournitures", "Modifier les fournitures"),
            ("supplies.delete", "Supprimer fournitures", "Retirer des fournitures"),
            ("supplies.order", "Commander", "Passer des commandes fournisseurs"),
            ("supplies.receive", "R√©ceptionner", "R√©ceptionner les livraisons"),
            ("supplies.audit", "Audit fournitures", "Auditer les fournitures"),
        ],
        
        "reports": [
            ("reports.view", "Voir rapports", "Consulter les rapports"),
            ("reports.create", "Cr√©er rapports", "G√©n√©rer de nouveaux rapports"),
            ("reports.export", "Exporter rapports", "Exporter les rapports"),
            ("reports.schedule", "Programmer rapports", "Automatiser la g√©n√©ration"),
            ("reports.analytics", "Analyses avanc√©es", "Acc√©der aux analyses d√©taill√©es"),
            ("reports.dashboard", "Tableaux de bord", "Configurer les dashboards"),
        ],
        
        "analytics": [
            ("analytics.view", "Voir analyses", "Consulter les analyses"),
            ("analytics.sales", "Analyses ventes", "Analyser les performances de vente"),
            ("analytics.customers", "Analyses clients", "Analyser le comportement client"),
            ("analytics.products", "Analyses produits", "Analyser les performances produits"),
            ("analytics.financial", "Analyses financi√®res", "Analyser la sant√© financi√®re"),
            ("analytics.predictive", "Analyses pr√©dictives", "Acc√©der aux pr√©dictions"),
        ],
        
        "settings": [
            ("settings.view", "Voir param√®tres", "Consulter la configuration"),
            ("settings.update", "Modifier param√®tres", "Modifier la configuration syst√®me"),
            ("settings.backup", "Sauvegardes", "G√©rer les sauvegardes"),
            ("settings.restore", "Restaurations", "Restaurer des sauvegardes"),
            ("settings.integrations", "Int√©grations", "Configurer les int√©grations externes"),
            ("settings.notifications", "Notifications", "Configurer les notifications"),
            ("settings.security", "S√©curit√©", "G√©rer les param√®tres de s√©curit√©"),
        ],
        
        "monitoring": [
            ("monitoring.view", "Voir monitoring", "Consulter les m√©triques syst√®me"),
            ("monitoring.logs", "Voir logs", "Acc√©der aux journaux syst√®me"),
            ("monitoring.performance", "Performance", "Surveiller les performances"),
            ("monitoring.errors", "Gestion erreurs", "G√©rer les erreurs syst√®me"),
            ("monitoring.alerts", "Alertes syst√®me", "Configurer les alertes"),
        ],
        
        "alerts": [
            ("alerts.view", "Voir alertes", "Consulter les alertes"),
            ("alerts.create", "Cr√©er alertes", "Configurer de nouvelles alertes"),
            ("alerts.update", "Modifier alertes", "Modifier les alertes existantes"),
            ("alerts.delete", "Supprimer alertes", "Retirer des alertes"),
            ("alerts.acknowledge", "Acquitter", "Marquer les alertes comme vues"),
            ("alerts.escalate", "Escalader", "Escalader des alertes critiques"),
        ],
        
        "audit": [
            ("audit.view", "Voir audits", "Consulter les journaux d'audit"),
            ("audit.export", "Exporter audits", "Exporter les donn√©es d'audit"),
            ("audit.configure", "Configurer audit", "Param√©trer l'audit syst√®me"),
            ("audit.compliance", "Conformit√©", "G√©rer la conformit√© r√©glementaire"),
        ],
        
        "help": [
            ("help.view", "Voir aide", "Acc√©der √† la documentation"),
            ("help.support", "Support", "Contacter le support technique"),
            ("help.training", "Formation", "Acc√©der aux ressources de formation"),
        ]
    }
    
    print(f"\nüìã PERMISSIONS RECOMMAND√âES PAR CAT√âGORIE:")
    total_recommended = 0
    
    for category, permissions in recommended_permissions.items():
        print(f"\nüîπ {category.upper()} ({len(permissions)} permissions)")
        for code, name, description in permissions:
            print(f"   ‚Ä¢ {code} - {name}")
            print(f"     ‚îî‚îÄ {description}")
        total_recommended += len(permissions)
    
    print(f"\nüìä R√âSUM√â:")
    print(f"   ‚Ä¢ Total recommand√©: {total_recommended} permissions")
    print(f"   ‚Ä¢ Cat√©gories: {len(recommended_permissions)}")
    
    return recommended_permissions

def compare_current_vs_recommended(current_categories, recommended_permissions):
    """Comparer les permissions actuelles avec les recommandations"""
    print(f"\nüîÑ COMPARAISON ACTUEL VS RECOMMAND√â")
    print("=" * 60)
    
    # Permissions actuelles
    current_codes = set()
    for cat, perms in current_categories.items():
        for perm in perms:
            current_codes.add(perm.code)
    
    # Permissions recommand√©es
    recommended_codes = set()
    for cat, perms in recommended_permissions.items():
        for code, name, desc in perms:
            recommended_codes.add(code)
    
    # Analyse
    missing = recommended_codes - current_codes
    extra = current_codes - recommended_codes
    common = current_codes & recommended_codes
    
    print(f"üìä STATISTIQUES:")
    print(f"   ‚Ä¢ Permissions actuelles: {len(current_codes)}")
    print(f"   ‚Ä¢ Permissions recommand√©es: {len(recommended_codes)}")
    print(f"   ‚Ä¢ Communes: {len(common)}")
    print(f"   ‚Ä¢ Manquantes: {len(missing)}")
    print(f"   ‚Ä¢ En surplus: {len(extra)}")
    
    if missing:
        print(f"\n‚ùå PERMISSIONS MANQUANTES ({len(missing)}):")
        for code in sorted(missing):
            # Trouver la cat√©gorie et description
            for cat, perms in recommended_permissions.items():
                for rec_code, name, desc in perms:
                    if rec_code == code:
                        print(f"   ‚Ä¢ {code} ({cat}) - {name}")
                        break
    
    if extra:
        print(f"\n‚ûï PERMISSIONS SUPPL√âMENTAIRES ({len(extra)}):")
        for code in sorted(extra):
            print(f"   ‚Ä¢ {code}")
    
    # Calcul du score de compl√©tude
    completeness = (len(common) / len(recommended_codes)) * 100 if recommended_codes else 0
    print(f"\nüìà SCORE DE COMPL√âTUDE: {completeness:.1f}%")
    
    return missing, extra, completeness

def security_recommendations():
    """Recommandations de s√©curit√© pour les permissions"""
    print(f"\nüîê RECOMMANDATIONS DE S√âCURIT√â")
    print("=" * 60)
    
    recommendations = [
        "üîπ PRINCIPE DU MOINDRE PRIVIL√àGE",
        "   ‚Ä¢ Accordez uniquement les permissions n√©cessaires",
        "   ‚Ä¢ R√©visez r√©guli√®rement les permissions accord√©es",
        "   ‚Ä¢ Supprimez les permissions inutilis√©es",
        "",
        "üîπ S√âPARATION DES RESPONSABILIT√âS",
        "   ‚Ä¢ S√©parez les permissions critiques (ex: delete, approve)",
        "   ‚Ä¢ √âvitez de donner tous les pouvoirs √† un seul utilisateur",
        "   ‚Ä¢ Impl√©mentez des workflows d'approbation",
        "",
        "üîπ AUDIT ET TRA√áABILIT√â",
        "   ‚Ä¢ Loggez toutes les actions sensibles",
        "   ‚Ä¢ Gardez un historique des changements de permissions",
        "   ‚Ä¢ Surveillez les acc√®s anormaux",
        "",
        "üîπ GESTION DES R√îLES",
        "   ‚Ä¢ Cr√©ez des r√¥les pr√©d√©finis (Admin, Manager, Staff, etc.)",
        "   ‚Ä¢ Utilisez des templates de permissions par r√¥le",
        "   ‚Ä¢ Facilitez l'attribution en masse",
        "",
        "üîπ S√âCURIT√â TECHNIQUE",
        "   ‚Ä¢ Validez les permissions c√¥t√© backend ET frontend",
        "   ‚Ä¢ Utilisez des tokens JWT avec expiration",
        "   ‚Ä¢ Impl√©mentez une authentification √† deux facteurs",
        "   ‚Ä¢ Chiffrez les donn√©es sensibles",
        "",
        "üîπ CONFORMIT√â",
        "   ‚Ä¢ Respectez les r√©glementations (RGPD, etc.)",
        "   ‚Ä¢ Documentez les acc√®s aux donn√©es personnelles",
        "   ‚Ä¢ Impl√©mentez le droit √† l'oubli",
        "",
        "üîπ MONITORING",
        "   ‚Ä¢ Alertes sur les actions critiques",
        "   ‚Ä¢ D√©tection d'anomalies dans les acc√®s",
        "   ‚Ä¢ Rapports r√©guliers d'utilisation des permissions"
    ]
    
    for rec in recommendations:
        print(rec)

def main():
    """Fonction principale d'analyse"""
    print("üöÄ ANALYSE COMPL√àTE DU SYST√àME DE PERMISSIONS")
    print("Recommandations pour une application web s√©curis√©e")
    print()
    
    # 1. Analyser les permissions actuelles
    current_categories = analyze_current_permissions()
    
    # 2. Recommandations compl√®tes
    recommended_permissions = recommend_complete_permission_system()
    
    # 3. Comparaison
    missing, extra, completeness = compare_current_vs_recommended(current_categories, recommended_permissions)
    
    # 4. Recommandations de s√©curit√©
    security_recommendations()
    
    # 5. Conclusion
    print(f"\n" + "=" * 60)
    print(f"üìã CONCLUSION:")
    
    if completeness >= 80:
        print(f"‚úÖ Syst√®me de permissions bien d√©velopp√© ({completeness:.1f}%)")
    elif completeness >= 60:
        print(f"‚ö†Ô∏è  Syst√®me de permissions correct mais incomplet ({completeness:.1f}%)")
    else:
        print(f"‚ùå Syst√®me de permissions insuffisant ({completeness:.1f}%)")
    
    print(f"\nüí° PROCHAINES √âTAPES RECOMMAND√âES:")
    print(f"   1. Impl√©menter les {len(missing)} permissions manquantes")
    print(f"   2. Cr√©er des r√¥les pr√©d√©finis avec templates")
    print(f"   3. Am√©liorer l'audit et la tra√ßabilit√©")
    print(f"   4. Tester la s√©curit√© avec des tests de p√©n√©tration")
    print(f"   5. Former les utilisateurs sur la s√©curit√©")

if __name__ == '__main__':
    main()
