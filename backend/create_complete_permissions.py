#!/usr/bin/env python
"""
Script pour cr√©er un syst√®me de permissions complet pour BarStockWise
Con√ßu par un expert en s√©curit√© d'applications web
"""

import os
import sys
import django

# Configuration Django
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'barstock_api.settings')
django.setup()

from accounts.models import Permission

def create_comprehensive_permissions():
    """Cr√©er un syst√®me de permissions complet et s√©curis√©"""
    print("üîê CR√âATION D'UN SYST√àME DE PERMISSIONS COMPLET")
    print("=" * 55)
    
    # Syst√®me de permissions granulaires pour une application de gestion de bar
    permissions_data = [
        
        # ===== DASHBOARD & CORE =====
        {
            'code': 'dashboard.view',
            'name': 'Acc√©der au tableau de bord',
            'description': 'Acc√®s √† la page d\'accueil et aux statistiques g√©n√©rales',
            'category': 'dashboard'
        },
        {
            'code': 'profile.view',
            'name': 'Voir son profil',
            'description': 'Consulter ses informations personnelles',
            'category': 'profile'
        },
        {
            'code': 'profile.update',
            'name': 'Modifier son profil',
            'description': 'Mettre √† jour ses informations personnelles',
            'category': 'profile'
        },
        
        # ===== SALES (VENTES) =====
        {
            'code': 'sales.view',
            'name': 'Voir les ventes',
            'description': 'Consulter la liste des ventes et le POS',
            'category': 'sales'
        },
        {
            'code': 'sales.create',
            'name': 'Cr√©er des ventes',
            'description': 'Effectuer des ventes via le syst√®me POS',
            'category': 'sales'
        },
        {
            'code': 'sales.update',
            'name': 'Modifier les ventes',
            'description': 'Modifier les ventes existantes (avant finalisation)',
            'category': 'sales'
        },
        {
            'code': 'sales.delete',
            'name': 'Supprimer les ventes',
            'description': 'Annuler ou supprimer des ventes',
            'category': 'sales'
        },
        {
            'code': 'sales.history',
            'name': 'Historique des ventes',
            'description': 'Acc√®s √† l\'historique complet des ventes',
            'category': 'sales'
        },
        {
            'code': 'sales.approve',
            'name': 'Approuver les ventes',
            'description': 'Valider les ventes en attente d\'approbation',
            'category': 'sales'
        },
        {
            'code': 'sales.refund',
            'name': 'Effectuer des remboursements',
            'description': 'Traiter les remboursements et retours',
            'category': 'sales'
        },
        {
            'code': 'sales.discount',
            'name': 'Appliquer des remises',
            'description': 'Accorder des remises sur les ventes',
            'category': 'sales'
        },
        
        # ===== PRODUCTS (PRODUITS) =====
        {
            'code': 'products.view',
            'name': 'Voir les produits',
            'description': 'Consulter le catalogue des produits',
            'category': 'products'
        },
        {
            'code': 'products.create',
            'name': 'Cr√©er des produits',
            'description': 'Ajouter de nouveaux produits au catalogue',
            'category': 'products'
        },
        {
            'code': 'products.update',
            'name': 'Modifier les produits',
            'description': 'Mettre √† jour les informations des produits',
            'category': 'products'
        },
        {
            'code': 'products.delete',
            'name': 'Supprimer les produits',
            'description': 'Retirer des produits du catalogue',
            'category': 'products'
        },
        {
            'code': 'products.pricing',
            'name': 'G√©rer les prix',
            'description': 'Modifier les prix des produits',
            'category': 'products'
        },
        
        # ===== INVENTORY (STOCKS) =====
        {
            'code': 'inventory.view',
            'name': 'Voir les stocks',
            'description': 'Consulter les niveaux de stock',
            'category': 'inventory'
        },
        {
            'code': 'inventory.update',
            'name': 'Mettre √† jour les stocks',
            'description': 'Modifier les quantit√©s en stock',
            'category': 'inventory'
        },
        {
            'code': 'inventory.audit',
            'name': 'Auditer les stocks',
            'description': 'Effectuer des inventaires et audits',
            'category': 'inventory'
        },
        {
            'code': 'inventory.alerts',
            'name': 'G√©rer les alertes stock',
            'description': 'Configurer et recevoir les alertes de stock',
            'category': 'inventory'
        },
        {
            'code': 'inventory.transfer',
            'name': 'Transf√©rer les stocks',
            'description': 'Effectuer des transferts entre emplacements',
            'category': 'inventory'
        },
        
        # ===== SUPPLIES (APPROVISIONNEMENTS) =====
        {
            'code': 'supplies.view',
            'name': 'Voir les approvisionnements',
            'description': 'Consulter les commandes fournisseurs',
            'category': 'supplies'
        },
        {
            'code': 'supplies.create',
            'name': 'Cr√©er des commandes',
            'description': 'Passer des commandes aux fournisseurs',
            'category': 'supplies'
        },
        {
            'code': 'supplies.update',
            'name': 'Modifier les commandes',
            'description': 'Mettre √† jour les commandes en cours',
            'category': 'supplies'
        },
        {
            'code': 'supplies.approve',
            'name': 'Approuver les commandes',
            'description': 'Valider les commandes avant envoi',
            'category': 'supplies'
        },
        {
            'code': 'supplies.receive',
            'name': 'R√©ceptionner les livraisons',
            'description': 'Traiter les r√©ceptions de marchandises',
            'category': 'supplies'
        },
        
        # ===== KITCHEN (CUISINE) =====
        {
            'code': 'kitchen.view',
            'name': 'Voir les commandes cuisine',
            'description': 'Acc√®s √† l\'interface cuisine',
            'category': 'kitchen'
        },
        {
            'code': 'kitchen.manage',
            'name': 'G√©rer les commandes',
            'description': 'Traiter et organiser les commandes cuisine',
            'category': 'kitchen'
        },
        {
            'code': 'kitchen.recipes',
            'name': 'G√©rer les recettes',
            'description': 'Cr√©er et modifier les recettes',
            'category': 'kitchen'
        },
        
        # ===== TABLES & ORDERS =====
        {
            'code': 'tables.view',
            'name': 'Voir les tables',
            'description': 'Consulter l\'√©tat des tables',
            'category': 'tables'
        },
        {
            'code': 'tables.manage',
            'name': 'G√©rer les tables',
            'description': 'Assigner et organiser les tables',
            'category': 'tables'
        },
        {
            'code': 'orders.view',
            'name': 'Voir les commandes',
            'description': 'Consulter les commandes en cours',
            'category': 'orders'
        },
        {
            'code': 'orders.create',
            'name': 'Cr√©er des commandes',
            'description': 'Prendre des commandes clients',
            'category': 'orders'
        },
        {
            'code': 'orders.update',
            'name': 'Modifier les commandes',
            'description': 'Mettre √† jour les commandes existantes',
            'category': 'orders'
        },
        {
            'code': 'orders.cancel',
            'name': 'Annuler les commandes',
            'description': 'Annuler des commandes en cours',
            'category': 'orders'
        },
        
        # ===== USERS (UTILISATEURS) =====
        {
            'code': 'users.view',
            'name': 'Voir les utilisateurs',
            'description': 'Consulter la liste des utilisateurs',
            'category': 'users'
        },
        {
            'code': 'users.create',
            'name': 'Cr√©er des utilisateurs',
            'description': 'Ajouter de nouveaux utilisateurs',
            'category': 'users'
        },
        {
            'code': 'users.update',
            'name': 'Modifier les utilisateurs',
            'description': 'Mettre √† jour les informations utilisateurs',
            'category': 'users'
        },
        {
            'code': 'users.delete',
            'name': 'Supprimer les utilisateurs',
            'description': 'D√©sactiver ou supprimer des utilisateurs',
            'category': 'users'
        },
        {
            'code': 'users.permissions',
            'name': 'G√©rer les permissions',
            'description': 'Assigner et modifier les permissions utilisateurs',
            'category': 'users'
        },
        {
            'code': 'users.roles',
            'name': 'G√©rer les r√¥les',
            'description': 'Cr√©er et modifier les r√¥les utilisateurs',
            'category': 'users'
        },
        
        # ===== SUPPLIERS (FOURNISSEURS) =====
        {
            'code': 'suppliers.view',
            'name': 'Voir les fournisseurs',
            'description': 'Consulter la liste des fournisseurs',
            'category': 'suppliers'
        },
        {
            'code': 'suppliers.create',
            'name': 'Cr√©er des fournisseurs',
            'description': 'Ajouter de nouveaux fournisseurs',
            'category': 'suppliers'
        },
        {
            'code': 'suppliers.update',
            'name': 'Modifier les fournisseurs',
            'description': 'Mettre √† jour les informations fournisseurs',
            'category': 'suppliers'
        },
        {
            'code': 'suppliers.delete',
            'name': 'Supprimer les fournisseurs',
            'description': 'Retirer des fournisseurs de la liste',
            'category': 'suppliers'
        },
        
        # ===== REPORTS & ANALYTICS =====
        {
            'code': 'reports.view',
            'name': 'Voir les rapports',
            'description': 'Consulter les rapports de gestion',
            'category': 'reports'
        },
        {
            'code': 'reports.create',
            'name': 'Cr√©er des rapports',
            'description': 'G√©n√©rer des rapports personnalis√©s',
            'category': 'reports'
        },
        {
            'code': 'reports.export',
            'name': 'Exporter les rapports',
            'description': 'T√©l√©charger les rapports en PDF/Excel',
            'category': 'reports'
        },
        {
            'code': 'analytics.view',
            'name': 'Voir les analyses',
            'description': 'Acc√®s aux tableaux de bord analytiques',
            'category': 'analytics'
        },
        {
            'code': 'analytics.advanced',
            'name': 'Analyses avanc√©es',
            'description': 'Acc√®s aux outils d\'analyse avanc√©e',
            'category': 'analytics'
        },
        
        # ===== FINANCES =====
        {
            'code': 'finances.view',
            'name': 'Voir les finances',
            'description': 'Consulter les donn√©es financi√®res',
            'category': 'finances'
        },
        {
            'code': 'finances.daily_report',
            'name': 'Rapports quotidiens',
            'description': 'Acc√®s aux rapports financiers quotidiens',
            'category': 'finances'
        },
        {
            'code': 'finances.expenses',
            'name': 'G√©rer les d√©penses',
            'description': 'Enregistrer et g√©rer les d√©penses',
            'category': 'finances'
        },
        {
            'code': 'finances.budget',
            'name': 'G√©rer le budget',
            'description': 'Planifier et suivre les budgets',
            'category': 'finances'
        },
        {
            'code': 'finances.accounting',
            'name': 'Comptabilit√©',
            'description': 'Acc√®s aux fonctions comptables avanc√©es',
            'category': 'finances'
        },
        
        # ===== SETTINGS & ADMINISTRATION =====
        {
            'code': 'settings.view',
            'name': 'Voir les param√®tres',
            'description': 'Consulter la configuration syst√®me',
            'category': 'settings'
        },
        {
            'code': 'settings.update',
            'name': 'Modifier les param√®tres',
            'description': 'Configurer les param√®tres syst√®me',
            'category': 'settings'
        },
        {
            'code': 'settings.security',
            'name': 'Param√®tres de s√©curit√©',
            'description': 'G√©rer la s√©curit√© et les acc√®s',
            'category': 'settings'
        },
        {
            'code': 'settings.backup',
            'name': 'Sauvegardes',
            'description': 'G√©rer les sauvegardes syst√®me',
            'category': 'settings'
        },
        
        # ===== MONITORING & ALERTS =====
        {
            'code': 'monitoring.view',
            'name': 'Surveillance syst√®me',
            'description': 'Surveiller les performances syst√®me',
            'category': 'monitoring'
        },
        {
            'code': 'alerts.view',
            'name': 'Voir les alertes',
            'description': 'Consulter les alertes syst√®me',
            'category': 'alerts'
        },
        {
            'code': 'alerts.manage',
            'name': 'G√©rer les alertes',
            'description': 'Configurer et traiter les alertes',
            'category': 'alerts'
        },
        
        # ===== HELP & SUPPORT =====
        {
            'code': 'help.view',
            'name': 'Acc√©der √† l\'aide',
            'description': 'Consulter la documentation et l\'aide',
            'category': 'help'
        },
        
        # ===== AUDIT & LOGS =====
        {
            'code': 'audit.view',
            'name': 'Voir les logs d\'audit',
            'description': 'Consulter les journaux d\'activit√©',
            'category': 'audit'
        },
        {
            'code': 'audit.export',
            'name': 'Exporter les audits',
            'description': 'T√©l√©charger les rapports d\'audit',
            'category': 'audit'
        }
    ]
    
    print(f"üìã Cr√©ation de {len(permissions_data)} permissions...")
    
    # Supprimer toutes les permissions existantes
    Permission.objects.all().delete()
    print("   üóëÔ∏è  Anciennes permissions supprim√©es")
    
    # Cr√©er toutes les nouvelles permissions
    created_count = 0
    categories = set()
    
    for perm_data in permissions_data:
        try:
            permission = Permission.objects.create(
                code=perm_data['code'],
                name=perm_data['name'],
                description=perm_data['description'],
                category=perm_data['category']
            )
            categories.add(perm_data['category'])
            created_count += 1
            
        except Exception as e:
            print(f"   ‚ùå Erreur pour {perm_data['code']}: {str(e)}")
    
    print(f"\nüìä R√âSULTAT:")
    print(f"   ‚Ä¢ Permissions cr√©√©es: {created_count}")
    print(f"   ‚Ä¢ Cat√©gories: {len(categories)}")
    
    # Afficher les cat√©gories
    print(f"\nüìÅ CAT√âGORIES CR√â√âES:")
    for category in sorted(categories):
        count = Permission.objects.filter(category=category).count()
        print(f"   ‚Ä¢ {category.upper()}: {count} permissions")
    
    return created_count

def assign_basic_permissions_to_testuser():
    """Assigner des permissions de base √† testuser_sales"""
    print(f"\nüë§ ATTRIBUTION DES PERMISSIONS √Ä testuser_sales")
    print("=" * 55)
    
    try:
        from accounts.models import User, UserPermission
        
        user = User.objects.get(username="testuser_sales")
        
        # Permissions de base pour un serveur
        basic_permissions = [
            'dashboard.view',
            'profile.view',
            'profile.update',
            'sales.view',
            'sales.create',
            'sales.history',
            'products.view',
            'tables.view',
            'tables.manage',
            'orders.view',
            'orders.create',
            'orders.update',
            'kitchen.view',
            'help.view'
        ]
        
        assigned_count = 0
        for perm_code in basic_permissions:
            try:
                permission = Permission.objects.get(code=perm_code)
                user_permission, created = UserPermission.objects.get_or_create(
                    user=user,
                    permission=permission,
                    defaults={'is_active': True}
                )
                
                if created or not user_permission.is_active:
                    user_permission.is_active = True
                    user_permission.save()
                    assigned_count += 1
                    print(f"   ‚úÖ {perm_code}")
                
            except Permission.DoesNotExist:
                print(f"   ‚ùå Permission non trouv√©e: {perm_code}")
        
        print(f"\nüìä Permissions assign√©es: {assigned_count}")
        return True
        
    except User.DoesNotExist:
        print("   ‚ùå Utilisateur testuser_sales non trouv√©")
        return False
    except Exception as e:
        print(f"   ‚ùå Erreur: {str(e)}")
        return False

def verify_frontend_compatibility():
    """V√©rifier la compatibilit√© avec le frontend"""
    print(f"\nüé® V√âRIFICATION COMPATIBILIT√â FRONTEND")
    print("=" * 55)
    
    # V√©rifier que toutes les cat√©gories sont pr√©sentes
    permissions = Permission.objects.all()
    
    # Simuler le groupement frontend
    grouped = {}
    for perm in permissions:
        category = perm.category or 'Autre'
        if category not in grouped:
            grouped[category] = []
        grouped[category].append({
            'id': perm.id,
            'code': perm.code,
            'name': perm.name,
            'category': perm.category
        })
    
    print(f"üìã Groupement pour le frontend:")
    for category, perms in grouped.items():
        print(f"   üìÅ {category.upper()}: {len(perms)} permissions")
    
    # V√©rifier les cat√©gories importantes
    important_categories = ['sales', 'users', 'products', 'inventory', 'reports']
    missing_categories = []
    
    for cat in important_categories:
        if cat not in grouped:
            missing_categories.append(cat)
    
    if missing_categories:
        print(f"\n‚ö†Ô∏è  Cat√©gories manquantes: {missing_categories}")
        return False
    else:
        print(f"\n‚úÖ Toutes les cat√©gories importantes sont pr√©sentes")
        return True

def main():
    """Fonction principale"""
    print("üöÄ CR√âATION D'UN SYST√àME DE PERMISSIONS COMPLET")
    print("Con√ßu par un expert en s√©curit√© d'applications web")
    print("Pour BarStockWise - Gestion de bar professionnelle")
    print()
    
    # 1. Cr√©er toutes les permissions
    created_count = create_comprehensive_permissions()
    
    # 2. Assigner des permissions de base √† l'utilisateur test
    user_assigned = assign_basic_permissions_to_testuser()
    
    # 3. V√©rifier la compatibilit√© frontend
    frontend_ok = verify_frontend_compatibility()
    
    # 4. R√©sum√© final
    print(f"\n" + "=" * 55)
    print(f"üìã R√âSUM√â FINAL:")
    
    print(f"   ‚Ä¢ Permissions cr√©√©es: {created_count}")
    print(f"   ‚Ä¢ Utilisateur configur√©: {'‚úÖ OUI' if user_assigned else '‚ùå NON'}")
    print(f"   ‚Ä¢ Frontend compatible: {'‚úÖ OUI' if frontend_ok else '‚ùå NON'}")
    
    if created_count > 0 and frontend_ok:
        print(f"\nüéâ SYST√àME DE PERMISSIONS COMPLET CR√â√â!")
        print(f"‚úÖ {created_count} permissions dans {len(set(p.category for p in Permission.objects.all()))} cat√©gories")
        print(f"‚úÖ Syst√®me granulaire et s√©curis√©")
        print(f"‚úÖ Compatible avec l'interface frontend")
        
        print(f"\nüîÑ ACTIONS REQUISES:")
        print(f"1. Red√©marrer le serveur Django")
        print(f"2. Actualiser le navigateur (Ctrl+Shift+R)")
        print(f"3. Tester le formulaire de cr√©ation d'utilisateur")
        print(f"4. V√©rifier que toutes les cat√©gories apparaissent")
        
        print(f"\nüîê S√âCURIT√â:")
        print(f"‚Ä¢ Permissions granulaires par fonctionnalit√©")
        print(f"‚Ä¢ S√©paration claire des responsabilit√©s")
        print(f"‚Ä¢ Contr√¥le d'acc√®s bas√© sur les r√¥les")
        print(f"‚Ä¢ Audit et tra√ßabilit√© int√©gr√©s")
    else:
        print(f"\n‚ö†Ô∏è  PROBL√àMES D√âTECT√âS")
        print(f"V√©rifiez les erreurs ci-dessus")

if __name__ == '__main__':
    main()
